import os
import speech_recognition as sr
import pyttsx3
import datetime
import threading
import geocoder

def listen_and_recognize():
    r = sr.Recognizer()
    engine = pyttsx3.init()
    engine.setProperty("rate", 150)

    with sr.Microphone() as source:
        r.adjust_for_ambient_noise(source)

        navigation_started = False
        sensation_active = False

        # Initial welcome message
        print("Welcome to Sensation")
        text_to_speech(engine, "Welcome to Sensation. You can start speaking now, Apurwa")

        while True:
            try:
                audio = r.listen(source, timeout=3)
                result = r.recognize_google(audio)
                print("You spoke:", result)

                if not sensation_active:
                    if result.lower() == "start sensation":
                        sensation_active = True
                        print("Sensation started.")
                        text_to_speech(engine, "Sensation started.")
                else:
                    if "what" in result.lower() and "time" in result.lower():
                        current_time = datetime.datetime.now().strftime("%H:%M")
                        print("The current time is:", current_time)
                        text_to_speech(engine, "The current time is " + current_time)
                    elif "position" in result.lower() or "location" in result.lower():
                        position = get_current_position()
                        print("Current position:", position)
                        text_to_speech(engine, "Your current position is " + position)
                    elif result.lower() == "stop sensation":
                        sensation_active = False
                        print("Sensation stopped.")
                        text_to_speech(engine, "Sensation stopped.")
                    elif "picture" in result.lower():
                        # take_picture()
                        print("Picture was successfully stored.")
                        text_to_speech(engine, "Picture was successfully stored.")
                    else:
                        text_to_speech(engine, "Invalid command.")

            except sr.WaitTimeoutError:
                pass
            except sr.UnknownValueError:
                pass
            except sr.RequestError as e:
                print("Error:", e)

def text_to_speech(engine, text):
    engine.say(text)
    engine.runAndWait()

# Function to retrieve the current position
def get_current_position():
    g = geocoder.ip('me')
    if g.ok:
        city = g.city if g.city else ""
        state = g.state if g.state else ""
        country = g.country if g.country else ""
        street = g.street if g.street else ""
        return f"{street}, {city}, {state}, {country}"
    else:
        return "Unable to retrieve current position"

# Call the listen_and_recognize() function
listen_and_recognize()
